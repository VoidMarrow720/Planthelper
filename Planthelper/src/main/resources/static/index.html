<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Planthelper Admin</title>
  <style>
    body{font-family: Arial, sans-serif; padding:20px}
    .row{display:flex; gap:12px; margin-bottom:12px}
    button{padding:8px 12px}
    .panel{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px}
    label{display:block;margin:6px 0 3px}
    select,input{padding:6px;width:100%}
    .flex{display:flex;gap:8px}
  </style>
</head>
<body>
  <h1>Planthelper - Admin UI</h1>

  <div class="panel">
    <h3>Create reference entries</h3>
    <div class="row">
      <div>
        <button onclick="showCreate('groups')">New Group</button>
      </div>
      <div>
        <button onclick="showCreate('light')">New Lite</button>
      </div>
      <div>
        <button onclick="showCreate('humidity')">New Hum</button>
      </div>
      <div>
        <button onclick="showCreate('soils')">New Soil</button>
      </div>
      <div>
        <button onclick="showCreate('temps')">New Temp</button>
      </div>
      <div>
        <button onclick="showCreate('waters')">New Water</button>
      </div>
    </div>

    <div id="createForm" style="display:none; margin-top:12px">
      <label id="createLabel">Create</label>
      <div class="flex">
        <input id="createTipe" placeholder="tipe (szöveg)" />
        <button onclick="createRef()">Create</button>
        <button onclick="hideCreate()">Cancel</button>
      </div>
    </div>
    <div id="refsList" style="margin-top:12px">
      <!-- dynamic reference lists will be rendered here -->
    </div>
  </div>

  <div class="panel">
    <h3>Add plant</h3>
    <label>Name</label>
    <input id="pNev" />
    <label>Latin name</label>
    <input id="pLatin" />

    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <label>Group (single)</label>
        <select id="selGroup"></select>
      </div>
      <div style="flex:1">
        <label>Light</label>
        <div id="litesContainer"></div>
        <div style="margin-top:6px"><button type="button" onclick="addSelect('light')">Add</button></div>
      </div>
      <div style="flex:1">
        <label>Hum</label>
        <div id="humsContainer"></div>
        <div style="margin-top:6px"><button type="button" onclick="addSelect('hums')">Add</button></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <label>Soil</label>
        <div id="soilsContainer"></div>
        <div style="margin-top:6px"><button type="button" onclick="addSelect('soils')">Add</button></div>
      </div>
      <div style="flex:1">
        <label>Temp</label>
        <div id="tempsContainer"></div>
        <div style="margin-top:6px"><button type="button" onclick="addSelect('temps')">Add</button></div>
      </div>
      <div style="flex:1">
        <label>Water</label>
        <div id="watersContainer"></div>
        <div style="margin-top:6px"><button type="button" onclick="addSelect('waters')">Add</button></div>
      </div>
    </div>
    <div style="margin-top:12px">
      <button onclick="addPlant()">Add Plant</button>
      <button onclick="loadPlants()">Refresh Plants</button>
    </div>
  </div>

  <div class="panel">
    <h3>Plants</h3>
    <div id="plantsList">(loading...)</div>
  </div>

  <script>
    let creatingType = null;

    function showCreate(type){
      creatingType = type;
      document.getElementById('createLabel').innerText = 'Create '+type;
      document.getElementById('createForm').style.display = 'block';
      document.getElementById('createTipe').value = '';
    }
    function hideCreate(){
      creatingType = null;
      document.getElementById('createForm').style.display = 'none';
    }

    async function createRef(){
      const tipe = document.getElementById('createTipe').value.trim();
      if(!tipe) return alert('Adj meg egy tipe értéket');
      const res = await fetch('/'+creatingType, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({tipe})
      });
      if(res.ok){
        hideCreate(); loadAllRefs();
      } else alert('Hiba létrehozáskor');
    }

    const optionsCache = { lites:[], hums:[], soils:[], temps:[], waters:[], groups:[] };

    async function loadAllRefs(){
      await Promise.all([
        loadOptions('/groups', 'groups', 'selGroup'),
        loadOptions('/lites', 'lites'),
        loadOptions('/hums', 'hums'),
        loadOptions('/soils', 'soils'),
        loadOptions('/temps', 'temps'),
        loadOptions('/waters', 'waters')
      ]);
      // create initial selects (one each) for multiple containers
      ensureInitialSelects();
      renderRefLists();
    }

    async function loadOptions(url, key, singleSelectId){
      const res = await fetch(url);
      const arr = res.ok? await res.json() : [];
      optionsCache[key] = arr || [];
      if(singleSelectId){
        const sel = document.getElementById(singleSelectId);
        sel.innerHTML = '<option value="">-- none --</option>';
        arr.forEach(it=>{
          const opt = document.createElement('option');
          opt.value = it.id;
          opt.text = it.tipe || it.nev || ('#'+it.id);
          sel.appendChild(opt);
        });
      }
      // refresh existing dynamic selects options
      refreshDynamicSelects(key);
    }

    function refreshDynamicSelects(key){
      const map = { lites:'litesContainer', hums:'humsContainer', soils:'soilsContainer', temps:'tempsContainer', waters:'watersContainer' };
      const containerId = map[key];
      if(!containerId) return;
      const container = document.getElementById(containerId);
      if(!container) return;
      const selects = container.querySelectorAll('select');
      selects.forEach(sel => {
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- none --</option>' + optionsCache[key].map(it=>`<option value="${it.id}">${it.tipe||it.nev||('#'+it.id)}</option>`).join('');
        sel.value = cur;
      });
      // also refresh the refs list view
      renderRefLists();
    }

    function ensureInitialSelects(){
      ['lites','hums','soils','temps','waters'].forEach(key=>{
        const map = { lites:'litesContainer', hums:'humsContainer', soils:'soilsContainer', temps:'tempsContainer', waters:'watersContainer' };
        const container = document.getElementById(map[key]);
        if(container && container.children.length === 0){
          addSelect(key);
        }
      });
    }

    function addSelect(key){
      const map = { lites:'litesContainer', hums:'humsContainer', soils:'soilsContainer', temps:'tempsContainer', waters:'watersContainer' };
      const container = document.getElementById(map[key]);
      if(!container) return;
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex'; wrapper.style.gap = '6px'; wrapper.style.marginTop = '6px';
      const sel = document.createElement('select');
      sel.innerHTML = '<option value="">-- none --</option>' + (optionsCache[key]||[]).map(it=>`<option value="${it.id}">${it.tipe||it.nev||('#'+it.id)}</option>`).join('');
      const btn = document.createElement('button'); btn.type='button'; btn.innerText='Remove';
      btn.onclick = ()=> wrapper.remove();
      wrapper.appendChild(sel); wrapper.appendChild(btn);
      container.appendChild(wrapper);
      renderRefLists();
    }

    function renderRefLists(){
      const types = [
        {key:'groups', url:'/groups', title:'Groups'},
        {key:'lites', url:'/lites', title:'Lites'},
        {key:'hums', url:'/hums', title:'Hums'},
        {key:'soils', url:'/soils', title:'Soils'},
        {key:'temps', url:'/temps', title:'Temps'},
        {key:'waters', url:'/waters', title:'Waters'}
      ];
      const root = document.getElementById('refsList');
      root.innerHTML = '';
      // render all types side-by-side in a single row
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '16px';
      row.style.flexWrap = 'wrap';
      types.forEach(t=>{
        const box = document.createElement('div');
        box.style.minWidth = '160px';
        box.style.border = '1px solid #eee';
        box.style.padding = '8px';
        box.style.borderRadius = '6px';
        box.style.background = '#fafafa';
        const title = document.createElement('div');
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '6px';
        title.innerText = t.title;

        const sel = document.createElement('select');
        sel.style.width = '100%';
        sel.innerHTML = '<option value="">-- none --</option>' + (optionsCache[t.key]||[]).map(it=>`<option value="${it.id}">${it.tipe||it.nev||('#'+it.id)}</option>`).join('');

        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.gap = '6px';
        btnRow.style.marginTop = '8px';

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.innerText = 'Delete';
        delBtn.onclick = async ()=>{
          const val = sel.value;
          if(!val) return alert('Válassz elemet a törléshez');
          if(!confirm('Törölni? '+ sel.options[sel.selectedIndex].text)) return;
          await deleteRef(t.key, val);
        };

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.innerText = 'Add';
        addBtn.onclick = ()=>{ showCreate(t.key); };

        btnRow.appendChild(addBtn);
        btnRow.appendChild(delBtn);

        box.appendChild(title);
        box.appendChild(sel);
        box.appendChild(btnRow);
        row.appendChild(box);
      });
      root.appendChild(row);
    }

    async function deleteRef(type, id){
      const res = await fetch('/'+type+'/'+id, { method: 'DELETE' });
      if(res.ok || res.status===204){
        await loadAllRefs();
      } else {
        alert('Törlés sikertelen');
      }
    }

    async function addPlant(){
      const nev = document.getElementById('pNev').value.trim();
      const latin = document.getElementById('pLatin').value.trim();
      if(!nev) return alert('Adj meg nevet');
      const payload = { nev, latinNev: latin };
      const groupVal = document.getElementById('selGroup').value;
      if(groupVal) payload.group = { id: Number(groupVal) };

      // helper to collect ids from container
      function collectIds(containerId){
        const container = document.getElementById(containerId);
        if(!container) return [];
        const ids = [];
        container.querySelectorAll('select').forEach(sel=>{
          const v = sel.value;
          if(v) ids.push({ id: Number(v) });
        });
        return ids;
      }

      const lites = collectIds('litesContainer'); if(lites.length) payload.lites = lites;
      const hums = collectIds('humsContainer'); if(hums.length) payload.hums = hums;
      const soils = collectIds('soilsContainer'); if(soils.length) payload.soils = soils;
      const temps = collectIds('tempsContainer'); if(temps.length) payload.temps = temps;
      const waters = collectIds('watersContainer'); if(waters.length) payload.waters = waters;

      const res = await fetch('/plants', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if(res.ok){ alert('Plant saved'); loadPlants(); } else { const txt = await res.text(); alert('Hiba mentéskor: '+txt); }
    }

    async function loadPlants(){
      const res = await fetch('/plants');
      const arr = res.ok? await res.json():[];
      const cont = document.getElementById('plantsList');
      cont.innerHTML = '';
      arr.forEach(p=>{
        const div = document.createElement('div');
        div.style.borderTop='1px solid #eee'; div.style.padding='8px 0';
        const parts = [];
        parts.push('<b>'+ (p.nev||'') +'</b> ('+(p.latinNev||'')+') - id:'+p.id);
        if(p.group) parts.push('Group: '+(p.group.tipe||p.group.id));
        if(p.lites && p.lites.length) parts.push('Light: '+ p.lites.map(x=>x.tipe||x.id).join(', '));
        if(p.hums && p.hums.length) parts.push('Humidity: '+ p.hums.map(x=>x.tipe||x.id).join(', '));
        if(p.soils && p.soils.length) parts.push('Soil: '+ p.soils.map(x=>x.tipe||x.id).join(', '));
        if(p.temps && p.temps.length) parts.push('Temp: '+ p.temps.map(x=>x.tipe||x.id).join(', '));
        if(p.waters && p.waters.length) parts.push('Water: '+ p.waters.map(x=>x.tipe||x.id).join(', '));
        // render text
        const text = document.createElement('span');
        text.innerHTML = parts.join(' | ');
        div.appendChild(text);
        // add delete button
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.style.marginLeft = '12px';
        delBtn.innerText = 'Delete';
        delBtn.onclick = async ()=>{
          if(!p.id) return alert('Nincs id');
          if(!confirm('Törölni a növényt: '+(p.nev||p.id)+' ?')) return;
          await deletePlant(p.id);
        };
        div.appendChild(delBtn);
        cont.appendChild(div);
      });
    }

    // initial load
    loadAllRefs(); loadPlants();
    
    async function deletePlant(id){
      const res = await fetch('/plants/'+id, { method: 'DELETE' });
      if(res.ok || res.status===204){
        await loadPlants();
      } else {
        const txt = await res.text();
        alert('Törlés sikertelen: '+(txt||res.status));
      }
    }
  </script>
</body>
</html>
